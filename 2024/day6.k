I:0:"day6.txt"
I:4(|+" ",)/I
S:-1_#'*:\I
C:S/+c:,/|-:\=2

I:,/I
D:4,(#I)
s:*&"^"=I

f:|+,/(S/1+!S-2),/:\:!#C
t:(f[0];f[1]+C f[0])

T:@[&*/D;D/f;:;D/t]
t:{(x;y+C x)}/4 0!'-1 0+f:f@\:&"#"=I@t[1]
T:@[T;D/f;:;D/t]

stp:{$[y[0;D/m:x@y[1]];:y;(@[y 0;D/m;:;1];m)]}
+/(^I)<|/(4,0N)#*stp[T]/(&*/D;0,s)

up:{f:{(x;y+C@4!x-2)}/+(!4),\:y;t:(4!f[0]-1;f[1]);@[x;D/f;:;D/t]}
i:0
+/~{ \">",$i+:1;|/(^I)&|/(4,0N)#*stp[up[T;x]]/(&*/D;0,s)}'&"."=I

/

vw:{S#@[I;(y[1];s;x);:;("^<v>"y[0];"S";"X")]}
